<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1f132b; /* Fallback color */
            background-image: linear-gradient(to bottom, #1d1525, #140d1d);
            min-height: 100vh;
        }
        .profile-selection-glow:hover {
            box-shadow: 0 0 15px #a78bfa; /* violet-400 */
        }
        .post-card {
            background-color: rgba(0, 0, 0, 0.3);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        /* Custom scrollbar for better dark mode aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #291f37; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #534b63; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #726b80; /* gray-500 */
        }
        #new-post-btn:hover {
            filter: brightness(0.9);
        }
        /* Style for posts that mention the current user */
        .mentioned-post {
            outline: 2px solid #9333EA;
            outline-offset: -2px;
        }
        /* Style for the @mention text itself */
        .mention-highlight {
            color: #c4b5fd; /* A light purple, tailwind violet-300 */
            font-weight: 600;
        }
        /* Ensure all avatars are circular and not squished */
        .avatar {
            object-fit: cover;
            flex-shrink: 0; /* Prevents avatar from shrinking in flex containers */
        }
        
        /* New post animation */
        @keyframes ease-in-from-top {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-post-animation {
            animation: ease-in-from-top 0.4s ease-out forwards;
        }
        
        /* Like toaster animation */
        @keyframes slide-in-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slide-out-down {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        .like-toaster-enter {
            animation: slide-in-up 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        .like-toaster-exit {
            animation: slide-out-down 0.5s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
        }

    </style>
</head>
<body class="text-white antialiased">

    <!-- App Container -->
    <div id="app-container" class="max-w-md md:max-w-2xl mx-auto h-screen flex flex-col">

        <!-- Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full p-8 text-center">
            <div class="flex-grow flex flex-col items-center justify-center">
                <h1 class="text-5xl font-bold mb-8" style="color: #7F3BC3;">yapper</h1>
                <h2 class="text-3xl font-bold mb-4">login</h2>
                <div id="character-selection-container" class="grid grid-cols-2 gap-4 mt-8">
                    <!-- Characters will be injected here by JS -->
                </div>
            </div>
            <button id="admin-login-button" class="text-gray-500 text-sm mt-8 hover:text-gray-300">admin</button>
        </div>

        <!-- Main App Screen -->
        <div id="main-app-screen" class="hidden h-full w-full flex-col">
            <!-- Header -->
            <header class="flex items-center justify-between p-4 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-700" style="background-color: rgba(45, 34, 55, 0.8);">
                <div class="flex items-center gap-3">
                    <img id="user-avatar-img" class="w-10 h-10 rounded-full avatar">
                     <div class="flex-1">
                        <span id="user-name" class="font-semibold block"></span>
                        <input type="text" id="status-input" class="bg-transparent text-xs text-gray-400 w-full focus:outline-none placeholder-gray-500 border-b border-transparent focus:border-purple-500 transition" placeholder="set status..">
                    </div>
                </div>
                <button id="logout-button" title="log out">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </header>

            <!-- Feed -->
            <main id="feed-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                <!-- Posts will be injected here -->
            </main>

            <!-- New Post Button -->
            <div class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md md:max-w-2xl p-4 z-20 pointer-events-none">
                 <button id="new-post-btn" class="w-full text-white font-bold py-4 px-4 rounded-full shadow-lg transition-all transform hover:scale-105 pointer-events-auto" style="background-color: #7F3BC3;">
                    new yap
                </button>
            </div>
        </div>

        <!-- New Post Modal -->
        <div id="new-post-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
             <div class="rounded-lg shadow-2xl w-full max-w-sm m-4" style="background-color: #1a171e;">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">new yap</h3>
                    <p id="replying-to-indicator" class="text-sm text-gray-400 hidden"></p>
                </div>
                <div class="p-4">
                    <textarea id="post-textarea" class="w-full h-28 bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none" placeholder="what's happening?"></textarea>
                    <div id="image-url-preview-container" class="mt-2 hidden">
                        <img id="image-url-preview" class="max-h-32 rounded-lg w-auto mx-auto" src="">
                    </div>
                    <input type="text" id="image-url-input" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm mt-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="paste image url...">
                </div>
                <div class="p-4 flex justify-between items-center gap-2 rounded-b-lg">
                    <div class="flex items-center">
                        <input id="anon-checkbox" type="checkbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                        <label for="anon-checkbox" class="ml-2 text-sm font-medium text-gray-300">make anon</label>
                    </div>
                    <div class="flex gap-2">
                        <button id="discard-post-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold">nah</button>
                        <button id="send-post-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md font-semibold disabled:bg-purple-900 disabled:cursor-not-allowed" disabled>yap</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="admin-password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
            <div class="rounded-lg shadow-2xl w-full max-w-sm m-4" style="background-color: #1B181F;">
                <div class="p-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold">enter admin pass</h3>
                </div>
                <div class="p-4">
                    <input id="admin-password-input" type="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="pass..">
                    <p id="admin-password-error" class="text-red-500 text-sm mt-2 hidden">wrong pass</p>
                </div>
                <div class="p-4 flex justify-end gap-2 rounded-b-lg">
                    <button id="admin-cancel-login-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold">nah</button>
                    <button id="admin-submit-login-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md font-semibold">login</button>
                </div>
            </div>
        </div>

        <!-- Admin Selector Modal -->
        <div id="admin-selector-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
            <div class="rounded-lg shadow-2xl w-full max-w-sm m-4" style="background-color: #1B181F;">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">select admin</h3>
                    <button id="admin-selector-close-btn">&times;</button>
                </div>
                <div id="admin-character-selection-container" class="grid grid-cols-3 gap-4 p-4">
                    <!-- Admin characters will be injected here -->
                </div>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
            <div class="rounded-lg shadow-2xl w-full max-w-sm m-4" style="background-color: #1B181F;">
                <div class="p-4 border-b border-gray-700">
                    <h3 id="password-modal-title" class="text-lg font-semibold">enter pass</h3>
                </div>
                <div class="p-4">
                    <input id="password-input" type="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="pass..">
                    <p id="password-error" class="text-red-500 text-sm mt-2 hidden">wrong pass</p>
                </div>
                <div class="p-4 flex justify-end gap-2 rounded-b-lg">
                    <button id="cancel-login-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold">nah</button>
                    <button id="submit-login-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md font-semibold">login</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
            <div class="rounded-lg shadow-2xl w-full max-w-sm m-4" style="background-color: #1B181F;">
                <div class="p-4">
                    <h3 id="confirm-modal-title" class="text-lg font-semibold">are u sure?</h3>
                    <p id="confirm-modal-text" class="text-gray-400 mt-2">this cannot be undone</p>
                </div>
                <div class="p-4 flex justify-end gap-2 rounded-b-lg">
                    <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold">nah</button>
                    <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md font-semibold">delete</button>
                </div>
            </div>
        </div>

        <!-- Like Toaster Notification -->
        <div id="like-toaster" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 z-50 w-full max-w-xs p-4">
            <div id="like-toaster-content" class="flex items-center p-3 rounded-full shadow-lg bg-gray-800 border border-purple-500 cursor-pointer">
                <img id="liker-avatar" class="w-10 h-10 rounded-full avatar" src="">
                <p id="liker-text" class="ml-3 text-sm font-medium"></p>
                 <svg class="ml-auto" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#FF70A2" stroke="#FF70A2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCjO0Z-aMLpH1b4sQ_bT3A_8m9DDeKlk7E",
            authDomain: "alina-a53ab.firebaseapp.com",
            projectId: "alina-a53ab",
            storageBucket: "alina-a53ab.appspot.com",
            messagingSenderId: "543963335916",
            appId: "1:543963335916:web:60a500d3aa43baaca5e9c9",
            measurementId: "G-DBSHERXPJ3"
        };
        
        // --- Character & User Config --- 
        const playerCharacters = {
            'rishu': { name: 'rishu', password: '42069', isAdmin: false, image: 'rishu.jpg', color: '#66a76d' },
            'tugemut': { name: 'tugemut', password: 'fish', isAdmin: false, image: 'tugemut.jpg', color: '#916f34' },
            'lyly': { name: 'lyly', password: 'aaaa', isAdmin: false, image: 'lyly.jpg', color: '#8850a9' },
            'tavima': { name: 'tavima', password: 'tazmani', isAdmin: false, image: 'tavima.jpg', color: '#4f7caa' },
        };

        const adminCharacters = {
            'keldonus': { name: 'keldonus', password: 'alina', isAdmin: true, image: 'kel.jpg', color: '#8674ec' },
            'thalen': { name: 'thalen', password: 'alina', isAdmin: true, image: 'thalen.jpg', color: '#2dd4bf' },
            'zail': { name: 'zail', password: 'alina', isAdmin: true, image: 'zail.jpg', color: '#f87171' },
            'jinjin': { name: `jin'jin`, password: 'alina', isAdmin: true, image: 'jinjin.jpg', color: '#5bd3db' },
            'delunia the overlord of eternal damnation': { name: 'delunia the overlord of eternal damnation', password: 'alina', isAdmin: true, image: 'nia.jpg', color: '#d1b538' },
            "n'zoth": { name: `n'zoth`, password: 'alina', isAdmin: true, image: 'nzoth.jpg', color: '#c02a10' },
            'tazmani': { name: 'tazmani', password: 'alina', isAdmin: true, image: 'kel.jpg', color: '#4A6AFF' },
            'arygos': { name: 'arygos', password: 'alina', isAdmin: true, image: 'arygos.jpg', color: '#BB72EC' },
            'tonttu': { name: 'tonttu', password: 'alina', isAdmin: true, image: 'tonttu.jpg', color: '#ff5a5a' },
            'alina': { name: 'alina', password: 'alina', isAdmin: true, image: 'alina.jpg', color: '#FFD720' },
            'benzi': { name: 'benzi', password: 'alina', isAdmin: true, image: 'benzi.jpg', color: '#FFF08E' },
            'tryanikus': { name: 'tryanikus', password: 'alina', isAdmin: true, image: 'tryanikus.jpg', color: '#65AB1F' },
        };
        
        const allCharacters = {...playerCharacters, ...adminCharacters};
 

        const appId = firebaseConfig.projectId || 'dnd-feed-app-public';
        
        // --- App State ---
        let app, auth, db;
        let currentUser = null;
        let selectedCharacterId = null;
        let postToDeleteId = null;
        let replyingToPostId = null;
        let replyingToPostAuthor = null;
        let postsCache = [];
        let initialLoadComplete = false;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainAppScreen = document.getElementById('main-app-screen');
        const feedContainer = document.getElementById('feed-container');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const userName = document.getElementById('user-name');
        const statusInput = document.getElementById('status-input');
        
        const newPostBtn = document.getElementById('new-post-btn');
        const newPostModal = document.getElementById('new-post-modal');
        const postTextarea = document.getElementById('post-textarea');
        const imageUrlInput = document.getElementById('image-url-input');
        const imageUrlPreviewContainer = document.getElementById('image-url-preview-container');
        const imageUrlPreview = document.getElementById('image-url-preview');
        const discardPostBtn = document.getElementById('discard-post-btn');
        const sendPostBtn = document.getElementById('send-post-btn');
        const logoutButton = document.getElementById('logout-button');
        
        const characterSelectionContainer = document.getElementById('character-selection-container');
        const adminCharacterSelectionContainer = document.getElementById('admin-character-selection-container');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminPasswordModal = document.getElementById('admin-password-modal');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminPasswordError = document.getElementById('admin-password-error');
        const adminCancelLoginBtn = document.getElementById('admin-cancel-login-btn');
        const adminSubmitLoginBtn = document.getElementById('admin-submit-login-btn');
        const adminSelectorModal = document.getElementById('admin-selector-modal');
        const adminSelectorCloseBtn = document.getElementById('admin-selector-close-btn');

        const passwordModal = document.getElementById('password-modal');
        const passwordModalTitle = document.getElementById('password-modal-title');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const cancelLoginBtn = document.getElementById('cancel-login-btn');
        const submitLoginBtn = document.getElementById('submit-login-btn');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        
        const anonCheckbox = document.getElementById('anon-checkbox');
        
        const likeToaster = document.getElementById('like-toaster');
        const likeToasterContent = document.getElementById('like-toaster-content');
        const likerAvatar = document.getElementById('liker-avatar');
        const likerText = document.getElementById('liker-text');


        // --- Helper Functions ---
        const timeAgo = (timestamp) => {
            if (!timestamp) return 'just now';
            const now = new Date();
            const seconds = Math.floor((now - timestamp.toDate()) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " min ago";
            return Math.floor(seconds) < 5 ? 'just now' : Math.floor(seconds) + ' sec ago';
        };

        const parseAndHighlightMentions = (text) => {
            if (!text) return '';
            const characterNames = Object.values(allCharacters).map(c => c.name);
            const mentionRegex = new RegExp(`@(${characterNames.join('|')})`, 'gi');
            return text.replace(mentionRegex, (match) => `<span class="mention-highlight">${match}</span>`);
        };
        
        const createPostElement = (post, posts) => {
            const postElement = document.createElement('div');
            
            if (post.type === 'status_update') {
                const canDelete = currentUser && (currentUser.isAdmin || post.authorId === currentUser.userId);
                const deleteButtonHTML = canDelete ? `
                    <button class="delete-post-btn text-gray-600 hover:text-red-500 p-1 -m-1 rounded-full" data-id="${post.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>` : '';
                
                const character = Object.values(allCharacters).find(c => c.name === post.authorName);
                const authorColor = character ? character.color : '#d1d5db';
                const statusText = post.text.replace(post.authorName, `<span class="font-bold" style="color: ${authorColor};">${post.authorName}</span>`);

                postElement.className = 'status-update-card text-center text-xs text-gray-500 italic py-2 flex justify-center items-center gap-2 cursor-pointer hover:bg-gray-800 rounded-md transition-colors';
                postElement.innerHTML = `<span>${statusText}</span> ${deleteButtonHTML}`;
            } else {
                let authorName, authorImage, authorColor;
                const anonAvatar = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%234b5563'/%3E%3C/svg%3E`;

                if (post.isAnonymous) {
                    authorName = 'anon'; authorImage = anonAvatar; authorColor = '#6b7280';
                } else {
                    const character = Object.values(allCharacters).find(c => c.name === post.authorName);
                    authorName = post.authorName;
                    if (character) {
                        authorImage = character.image; authorColor = character.color;
                    } else {
                        authorImage = anonAvatar; authorColor = '#d1d5db';
                    }
                }

                const isMentioned = currentUser && post.text && post.text.toLowerCase().includes(`@${currentUser.name.toLowerCase()}`);
                postElement.className = `p-4 rounded-lg post-card ${isMentioned ? 'mentioned-post' : ''}`;
                
                const likes = post.likes || [];
                const likeCount = likes.length;
                const isLikedByCurrentUser = currentUser && likes.some(like => like.userId === currentUser.userId);
                const likeCountDisplay = likeCount > 0 ? likeCount : '';

                const canDelete = currentUser && (currentUser.isAdmin || post.authorId === currentUser.userId);
                const deleteButtonHTML = canDelete ? `
                    <button class="delete-post-btn text-gray-500 hover:text-red-500 p-2 -m-2 rounded-full" data-id="${post.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>` : '';
                
                let replyPreviewHTML = '';
                if (post.replyToId) {
                    const originalPost = posts.find(p => p.id === post.replyToId);
                    if (originalPost) {
                        let opAuthorName, opAuthorImage, opAuthorColor;
                        const opAnonAvatar = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%234b5563'/%3E%3C/svg%3E`;

                        if (originalPost.isAnonymous) {
                            opAuthorName = 'anon'; opAuthorImage = opAnonAvatar; opAuthorColor = '#6b7280';
                        } else {
                            const opCharacter = Object.values(allCharacters).find(c => c.name === originalPost.authorName);
                            opAuthorName = originalPost.authorName;
                            if (opCharacter) {
                                opAuthorImage = opCharacter.image; opAuthorColor = opCharacter.color;
                            } else {
                                opAuthorImage = opAnonAvatar; opAuthorColor = '#d1d5db';
                            }
                        }
                        
                        const truncatedText = originalPost.text && originalPost.text.length > 70 ? originalPost.text.substring(0, 70) + '...' : originalPost.text;

                        replyPreviewHTML = `
                            <div class="mt-2 mb-2 p-2 border-l-2 border-gray-600 rounded-r-md bg-black bg-opacity-20">
                                <div class="flex items-center text-xs text-gray-400">
                                    <img src="${opAuthorImage}" class="w-4 h-4 rounded-full avatar mr-2">
                                    <span style="color: ${opAuthorColor}; font-weight: 600;">${opAuthorName}</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 italic">${truncatedText || ''}</p>
                            </div>`;
                    } else {
                        replyPreviewHTML = `<p class="text-xs text-gray-500 mb-2">↪ Replying to a deleted yap</p>`;
                    }
                }
                
                const imageHTML = post.imageUrl ? `<img src="${post.imageUrl}" class="mt-3 rounded-lg w-full h-auto object-cover"/>` : '';

                const likerNames = likes.map(like => like.name).join(', ');
                const likedByHTML = likerNames ? `<p class="text-xs text-gray-500 mt-2">liked by ${likerNames}</p>` : '';
                const authorStatusHTML = post.authorStatus ? `<span class="text-xs text-gray-400 font-normal ml-2">is ${post.authorStatus}</span>` : '';

                postElement.innerHTML = `
                    <div class="flex items-start">
                        <img src="${authorImage}" class="w-11 h-11 rounded-full mr-3 avatar">
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div class="flex items-baseline flex-wrap">
                                    <p class="font-bold" style="color: ${authorColor};">${authorName}</p>
                                    ${authorStatusHTML}
                                </div>
                                <div class="flex items-center gap-4">
                                    ${deleteButtonHTML}
                                    <div class="like-button flex items-center gap-2 text-gray-400 cursor-pointer transition-colors hover:text-white p-2 -m-2 rounded-full">
                                        <span class="like-count font-medium min-w-[1ch] text-right">${likeCountDisplay}</span>
                                        <svg class="like-heart pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="${isLikedByCurrentUser ? '#FF70A2' : 'none'}" stroke="${isLikedByCurrentUser ? '#FF70A2' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400">${timeAgo(post.timestamp)}</p>
                            ${replyPreviewHTML}
                            <p class="text-gray-300 whitespace-pre-wrap mt-1">${parseAndHighlightMentions(post.text)}</p>
                            ${imageHTML}
                            ${likedByHTML}
                        </div>
                    </div>`;
            }

            postElement.dataset.id = post.id;
            return postElement;
        }
        
       const renderPosts = (posts, newPostIds = new Set()) => {
            if (posts.length === 0) {
                feedContainer.innerHTML = `<div class="text-center text-gray-500 mt-10">
                    <p class="text-lg">feed is empty</p>
                    <p>be the first to post</p>
                </div>`;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            posts.forEach(post => {
                const postElement = createPostElement(post, posts);
                if (newPostIds.has(post.id)) {
                    postElement.classList.add('new-post-animation');
                    postElement.addEventListener('animationend', () => postElement.classList.remove('new-post-animation'), { once: true });
                }
                fragment.appendChild(postElement);
            });
            
            feedContainer.innerHTML = '';
            feedContainer.appendChild(fragment);
        };


        const showView = (view) => {
            loginScreen.classList.add('hidden');
            mainAppScreen.classList.add('hidden');
            document.getElementById(view).classList.remove('hidden');
            if(view === 'main-app-screen') {
                 document.getElementById(view).classList.add('flex');
            }
        };

        const setupUIForUser = (userProfile) => {
            currentUser = userProfile;
            userName.textContent = userProfile.name;
            userName.style.color = userProfile.color;
            userAvatarImg.src = userProfile.image;
            statusInput.value = userProfile.status || '';
            showView('main-app-screen');
        };

        const handleLogin = async () => {
             if (!auth || !auth.currentUser) { return; }
             const enteredPassword = passwordInput.value;
             const character = allCharacters[selectedCharacterId];

             if (enteredPassword === character.password) {
                const userProfile = { 
                    name: character.name, 
                    characterId: selectedCharacterId, 
                    isAdmin: character.isAdmin,
                    image: character.image,
                    color: character.color,
                    userId: auth.currentUser.uid,
                    status: ''
                };
                const userDocRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
                
                const existingDoc = await getDoc(userDocRef);
                if (existingDoc.exists()) {
                    userProfile.status = existingDoc.data().status || '';
                }

                await setDoc(userDocRef, userProfile);
                setupUIForUser(userProfile);
                passwordModal.classList.add('hidden');
                adminSelectorModal.classList.add('hidden');
             } else {
                passwordError.textContent = "wrong pass";
                passwordError.classList.remove('hidden');
             }
        }
        
        const closeAndResetPostModal = () => {
            newPostModal.classList.add('hidden');
            postTextarea.value = '';
            imageUrlInput.value = '';
            imageUrlPreviewContainer.classList.add('hidden');
            imageUrlPreview.src = '';
            anonCheckbox.checked = false;
            replyingToPostId = null;
            replyingToPostAuthor = null;
            document.getElementById('replying-to-indicator').classList.add('hidden');
        };

        // --- Event Listeners ---
        const openCharacterPasswordPrompt = (e) => {
            const characterDiv = e.target.closest('.character-choice');
            if (characterDiv) {
                selectedCharacterId = characterDiv.dataset.id;
                passwordModalTitle.textContent = `login as ${allCharacters[selectedCharacterId].name}`;
                passwordInput.value = '';
                passwordError.classList.add('hidden');
                passwordModal.classList.remove('hidden');
                passwordInput.focus();
            }
        }

        characterSelectionContainer.addEventListener('click', openCharacterPasswordPrompt);
        adminCharacterSelectionContainer.addEventListener('click', openCharacterPasswordPrompt);
        
        adminLoginButton.addEventListener('click', () => {
            adminPasswordInput.value = '';
            adminPasswordError.classList.add('hidden');
            adminPasswordModal.classList.remove('hidden');
            adminPasswordInput.focus();
        });

        adminCancelLoginBtn.addEventListener('click', () => adminPasswordModal.classList.add('hidden'));
        adminSubmitLoginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value === 'admin') {
                adminPasswordModal.classList.add('hidden');
                adminSelectorModal.classList.remove('hidden');
            } else {
                adminPasswordError.classList.remove('hidden');
            }
        });
        adminPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') adminSubmitLoginBtn.click();
        });

        adminSelectorCloseBtn.addEventListener('click', () => adminSelectorModal.classList.add('hidden'));
        cancelLoginBtn.addEventListener('click', () => passwordModal.classList.add('hidden'));
        submitLoginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        statusInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const newStatus = statusInput.value.trim();
                statusInput.blur(); 
                if (currentUser && newStatus !== currentUser.status) {
                    const userDocRef = doc(db, `artifacts/${appId}/users`, currentUser.userId);
                    await updateDoc(userDocRef, { status: newStatus });
                    currentUser.status = newStatus;

                    const statusUpdatePost = {
                        type: 'status_update',
                        authorName: currentUser.name,
                        authorId: currentUser.userId,
                        text: `${currentUser.name} is now ${newStatus}`,
                        timestamp: serverTimestamp(),
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), statusUpdatePost);
                }
            }
        });


        logoutButton.addEventListener('click', async () => {
            if (!auth.currentUser) return;
            const userDocRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
            await setDoc(userDocRef, {deleted: true}); 
            currentUser = null;
            initialLoadComplete = false;
            postsCache = [];
            showView('login-screen');
        });

        feedContainer.addEventListener('click', async (e) => {
            const likeButton = e.target.closest('.like-button');
            const deleteButton = e.target.closest('.delete-post-btn');
            const postCard = e.target.closest('.post-card');
            const statusUpdateCard = e.target.closest('.status-update-card');

            if (likeButton && currentUser) {
                e.stopPropagation();
                const postId = postCard.dataset.id;
                if (!postId) return;
                const postDocRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                const postDoc = await getDoc(postDocRef);
                if (!postDoc.exists()) return;
                const postData = postDoc.data();
                const likes = postData.likes || [];
                const isLiked = likes.some(like => like.userId === currentUser.userId);

                if (isLiked) {
                    const newLikes = likes.filter(like => like.userId !== currentUser.userId);
                    await updateDoc(postDocRef, { likes: newLikes });
                } else {
                    await updateDoc(postDocRef, { likes: arrayUnion({ userId: currentUser.userId, name: currentUser.name }) });
                }
                return;
            }

            if (deleteButton && currentUser) {
                e.stopPropagation();
                const postId = deleteButton.dataset.id;
                if (postId) {
                    postToDeleteId = postId;
                    confirmModalText.textContent = "this will be deleted";
                    confirmModal.classList.remove('hidden');
                }
                return;
            }
            
            if (statusUpdateCard) {
                const postId = statusUpdateCard.dataset.id;
                const post = postsCache.find(p => p.id === postId);
                if (postId && post) {
                    replyingToPostId = postId;
                    replyingToPostAuthor = post.authorName;
                    const replyingToIndicator = document.getElementById('replying-to-indicator');
                    replyingToIndicator.textContent = `replying to @${replyingToPostAuthor}`;
                    replyingToIndicator.classList.remove('hidden');
                    newPostModal.classList.remove('hidden');
                    postTextarea.focus();
                }
                return;
            }

            if (postCard) {
                const postId = postCard.dataset.id;
                const authorNameEl = postCard.querySelector('.font-bold');
                if (postId && authorNameEl) {
                    replyingToPostId = postId;
                    replyingToPostAuthor = authorNameEl.textContent;
                    const replyingToIndicator = document.getElementById('replying-to-indicator');
                    replyingToIndicator.textContent = `replying to @${replyingToPostAuthor}`;
                    replyingToIndicator.classList.remove('hidden');
                    newPostModal.classList.remove('hidden');
                    postTextarea.focus();
                }
            }
        });
        
        confirmCancelBtn.addEventListener('click', () => {
            postToDeleteId = null;
            confirmModal.classList.add('hidden');
        });

        confirmActionBtn.addEventListener('click', async () => {
            if (postToDeleteId) {
                const postDocRef = doc(db, `artifacts/${appId}/public/data/posts`, postToDeleteId);
                await deleteDoc(postDocRef);
                postToDeleteId = null;
                confirmModal.classList.add('hidden');
            }
        });

        newPostBtn.addEventListener('click', () => {
            newPostModal.classList.remove('hidden');
            postTextarea.focus();
        });

        discardPostBtn.addEventListener('click', closeAndResetPostModal);

        sendPostBtn.addEventListener('click', async () => {
            const text = postTextarea.value.trim();
            const imageUrl = imageUrlInput.value.trim();
            if (!text && !imageUrl) return;

            sendPostBtn.disabled = true;
            sendPostBtn.textContent = 'yapping...';

            try {
                const newPost = {
                    authorName: currentUser.name,
                    authorId: auth.currentUser.uid,
                    authorStatus: currentUser.status || '',
                    text: text,
                    imageUrl: imageUrl || null,
                    timestamp: serverTimestamp(),
                    likes: [],
                    replyToId: replyingToPostId,
                    replyToName: replyingToPostAuthor,
                    isAnonymous: anonCheckbox.checked,
                };
                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), newPost);
            } catch(error) {
                console.error("Error creating post: ", error);
            } finally {
                closeAndResetPostModal();
                sendPostBtn.disabled = false;
                sendPostBtn.textContent = 'yap';
            }
        });
        
        const checkSendButtonState = () => {
            const text = postTextarea.value.trim();
            const imageUrl = imageUrlInput.value.trim();
            sendPostBtn.disabled = !text && !imageUrl;
        }

        postTextarea.addEventListener('input', checkSendButtonState);
        imageUrlInput.addEventListener('input', () => {
            const url = imageUrlInput.value.trim();
            const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(url);
            if (isImage) {
                imageUrlPreview.src = url;
                imageUrlPreviewContainer.classList.remove('hidden');
            } else {
                imageUrlPreviewContainer.classList.add('hidden');
            }
            checkSendButtonState();
        });

        likeToaster.addEventListener('click', () => {
            likeToasterContent.classList.remove('like-toaster-enter');
            likeToasterContent.classList.add('like-toaster-exit');
            likeToasterContent.addEventListener('animationend', () => {
                likeToaster.classList.add('hidden');
                likeToasterContent.classList.remove('like-toaster-exit');
            }, { once: true });
        });


        // --- Initialization ---
        const initialize = () => {
            const createCharacterHTML = (char, id) => `
                <div data-id="${id}" class="character-choice cursor-pointer flex flex-col items-center gap-2 p-2 rounded-lg transition-all transform hover:scale-110 profile-selection-glow">
                    <img src="${char.image}" class="w-24 h-24 rounded-full avatar border-2 border-gray-600">
                    <p class="font-semibold">${char.name}</p>
                </div>`;

            characterSelectionContainer.innerHTML = Object.entries(playerCharacters)
                .map(([id, char]) => createCharacterHTML(char, id)).join('');
            
            adminCharacterSelectionContainer.innerHTML = Object.entries(adminCharacters)
                .map(([id, char]) => createCharacterHTML(char, id)).join('');

            if (!firebaseConfig.apiKey) { return; }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                    onSnapshot(userDocRef, (userDoc) => {
                        if (userDoc.exists() && !userDoc.data().deleted) {
                            setupUIForUser(userDoc.data());
                        } else {
                            currentUser = null;
                            showView('login-screen');
                        }
                    });
                    
                    const postsCollection = collection(db, `artifacts/${appId}/public/data/posts`);
                    onSnapshot(postsCollection, (querySnapshot) => {
                        const currentPosts = [];
                        querySnapshot.forEach((doc) => {
                            currentPosts.push({ id: doc.id, ...doc.data() });
                        });
                        currentPosts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                        
                        const newPostIds = new Set();
                        if (initialLoadComplete) {
                            const oldPostIds = new Set(postsCache.map(p => p.id));
                            currentPosts.forEach(p => {
                                if (!oldPostIds.has(p.id)) {
                                    newPostIds.add(p.id);
                                }
                            });
                        }

                        // Like notification logic
                        if (initialLoadComplete && currentUser) {
                            currentPosts.forEach(post => {
                                const oldPost = postsCache.find(p => p.id === post.id);
                                if (oldPost && post.authorId === currentUser.userId) {
                                    const oldLikes = oldPost.likes || [];
                                    const newLikes = post.likes || [];
                                    if (newLikes.length > oldLikes.length) {
                                        const newLiker = newLikes.find(nl => !oldLikes.some(ol => ol.userId === nl.userId));
                                        if (newLiker && newLiker.userId !== currentUser.userId) {
                                            const likerChar = Object.values(allCharacters).find(c => c.name === newLiker.name);
                                            likerAvatar.src = likerChar ? likerChar.image : '';
                                            likerText.innerHTML = `<span style="color:${likerChar.color}">${newLiker.name}</span> liked your post`;
                                            likeToaster.classList.remove('hidden');
                                            likeToasterContent.classList.remove('like-toaster-exit'); 
                                            likeToasterContent.classList.add('like-toaster-enter');
                                        }
                                    }
                                }
                            });
                        }

                        renderPosts(currentPosts, newPostIds);
                        postsCache = JSON.parse(JSON.stringify(currentPosts));
                        if (!initialLoadComplete) {
                            initialLoadComplete = true;
                        }

                    }, (error) => { console.error("Snapshot listener error:", error); });

                } else {
                    console.error("Authentication failed and no user is available.");
                }
            });

            (async () => {
                try {
                    await signInAnonymously(auth);
                } catch (error) { console.error("Anonymous sign-in error: ", error); }
            })();
        };

        initialize();
    </script>
</body>
</html>

